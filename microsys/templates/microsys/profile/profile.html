{% extends 'microsys/base.html' %}
{% load django_tables2 %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}{{ MS_TRANS.profile }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'microsys/users/css/profile.css' %}">


<div class="row justify-content-center mt-4">
    <div class="col-lg-10">
        <div class="glass-profile">
            <h1 class="page-title text-center display-6">
                <i class="bi bi-person-circle me-2"></i> {{ MS_TRANS.profile }}
            </h1>

            <div class="row align-items-start">
                <!-- Profile Image Section -->
                <div class="col-md-4 text-center mb-4 mb-md-0 border-start ps-md-4">
                    <div class="profile-img-container mb-3">
                        {% if user.profile.profile_picture %}
                            <img src="{{ user.profile.profile_picture.url }}" alt="Profile Image">
                        {% else %}
                            <img src="{% static 'img/default_profile.webp' %}" alt="Profile Image">
                        {% endif %}
                    </div>
                    <h3 class="fw-bold text-primary mb-1">
                        {{ user.profile.full_name }} 
                        {% if user.is_active %}<i class="bi bi-check-circle-fill text-success fs-5" title="{{ MS_TRANS.account_active }}"></i>{% endif %}
                    </h3>
                    <div class="mb-3">
                        <span class="badge bg-primary badge-role">{{ MS_TRANS.badge_verified }}</span>
                        {% if user.is_superuser %}
                            <span class="badge bg-danger badge-role">{{ MS_TRANS.badge_admin }}</span>
                        {% elif user.is_staff %}
                            <span class="badge bg-info text-dark badge-role">{{ MS_TRANS.badge_staff }}</span>
                        {% endif %}
                    </div>
                    
                    <!-- Account Health -->
                    <div class="mt-4 p-3 rounded bg-light border">
                         <small class="text-muted d-block mb-1">{{ MS_TRANS.account_health }}</small>
                         {% if stats.health == 'good' %}
                             <div class="d-flex align-items-center justify-content-center gap-2 text-success fw-bold">
                                 <i class="bi bi-heart-pulse-fill"></i> {{ MS_TRANS.account_health_good }}
                             </div>
                         {% else %}
                             <div class="d-flex align-items-center justify-content-center gap-2 text-warning fw-bold">
                                 <i class="bi bi-exclamation-triangle-fill"></i> {{ MS_TRANS.account_health_attention }}
                             </div>
                         {% endif %}
                    </div>
                </div>

                <!-- Info Section -->
                <div class="col-md-8 pe-md-4">
                    
                    <!-- Completeness -->
                    <div class="completeness-container">
                        <div class="completeness-label">
                            <span>{{ MS_TRANS.profile_completeness }}</span>
                            <span>{{ stats.completeness }}%</span>
                        </div>
                        <div class="progress progress-custom">
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ stats.completeness }}%" aria-valuenow="{{ stats.completeness }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>

                    <!-- Info Grid -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="mb-2">
                                <div class="info-label">{{ MS_TRANS.tbl_username }}</div>
                                <div class="info-value">{{ user.username }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-2">
                                <div class="info-label">{{ MS_TRANS.tbl_email }}</div>
                                <div class="info-value">{{ user.email|default:"-" }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-2">
                                <div class="info-label">{{ MS_TRANS.tbl_phone }}</div>
                                <div class="info-value">{{ user.profile.phone|default:"-" }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-2">
                                <div class="info-label">{{ MS_TRANS.role_type }}</div>
                                <div class="info-value">
                                    {% if user.is_superuser %}
                                        {{ MS_TRANS.role_superuser }}
                                    {% elif user.is_staff %}
                                        {{ MS_TRANS.role_staff }}
                                    {% else %}
                                        {{ MS_TRANS.role_user }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-2">
                                <div class="info-label">{{ MS_TRANS.date_joined }}</div>
                                <div class="info-value fs-6 text-dark">{{ user.date_joined|date:"d/m/Y" }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-2">
                                <div class="info-label">{{ MS_TRANS.tbl_last_login }}</div>
                                <div class="info-value fs-6 text-dark">{{ user.last_login|timesince }}</div>
                            </div>
                        </div>
                    </div>

                    </div>

                    <!-- 2FA Section -->
                    <div class="glass-card mb-4 p-3 d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1 text-muted">{{ MS_TRANS.2fa_title }}</h6>
                            <small class="text-muted d-block">{{ MS_TRANS.2fa_desc }}</small>
                        </div>
                        <div>
                            {% if user.profile.is_2fa_enabled %}
                                <span class="badge bg-success me-2"><i class="bi bi-shield-check"></i> Enabled</span>
                                <a href="{% url 'disable_2fa' %}" class="btn btn-sm btn-outline-danger">{{ MS_TRANS.2fa_disable }}</a>
                            {% else %}
                                <span class="badge bg-secondary me-2">Disabled</span>
                                <button type="button" 
                                        class="btn btn-sm btn-primary" 
                                        id="enable2FABtn"
                                        data-url="{% url 'enable_2fa' %}">
                                    {{ MS_TRANS.2fa_enable }}
                                </button>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="row g-3 mb-4">
                        <div class="col-6 col-lg-3">
                            <div class="stats-card text-center">
                                <div class="stats-icon text-primary"><i class="bi bi-bar-chart-steps"></i></div>
                                <div class="stats-value">{{ stats.total_actions }}</div>
                                <div class="stats-label">{{ MS_TRANS.stats_total_actions }}</div>
                            </div>
                        </div>
                         <!-- Add more stats if needed -->
                    </div>

    <!-- 2FA Setup Modal -->
    <div class="modal fade" id="otpSetupModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-card border-0">
                <div class="modal-header border-0">
                    <h5 class="modal-title">{{ MS_TRANS.2fa_verify_title }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-shield-lock-fill text-primary" style="font-size: 3rem;"></i>
                    </div>
                    <p class="text-muted mb-4">{{ MS_TRANS.2fa_verify_desc }}</p>
                    
                    <div id="otpSetupError" class="alert alert-danger d-none"></div>

                    <form id="otpSetupForm" data-url="{% url 'verify_otp_enable' %}" data-csrf="{{ csrf_token }}">
                        <div class="mb-3">
                            <input type="text" 
                                   class="form-control form-control-lg text-center fw-bold" 
                                   id="otpSetupInput" 
                                   name="otp_code" 
                                   placeholder="######" 
                                   maxlength="6" 
                                   required
                                   style="letter-spacing: 0.5em; font-size: 1.5rem;">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            {{ MS_TRANS.2fa_verify_btn }}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'microsys/users/js/profile_2fa.js' %}" nonce="{{ request.csp_nonce }}"></script>
                        <div class="col-6 col-lg-3">
                            <div class="stats-card text-center">
                                <div class="stats-icon text-success"><i class="bi bi-file-earmark-plus"></i></div>
                                <div class="stats-value">{{ stats.docs_created }}</div>
                                <div class="stats-label">{{ MS_TRANS.stats_docs_created }}</div>
                            </div>
                        </div>
                         <!-- Add more stats if needed -->
                    </div>

                    <!-- Timelines -->
                    <div class="row g-4">
                        <!-- Recent Activity -->
                        <div class="col-lg-6">
                             <h5 class="fw-bold mb-3 text-secondary"><i class="bi bi-clock-history me-2"></i> {{ MS_TRANS.stats_recent_activity }}</h5>
                             {% if recent_activity %}
                                 <div class="activity-timeline">
                                     {% for log in recent_activity %}
                                     <div class="timeline-item">
                                         <div class="timeline-dot"></div>
                                         <div class="timeline-content">
                                             <div class="timeline-time">{{ log.timestamp|timesince }}</div>
                                             <div class="timeline-title">{{ log.action }} - {{ log.model_name|default:"General" }}</div>
                                             <small class="text-muted">{{ log.object_id|default:"-" }}</small>
                                         </div>
                                     </div>
                                     {% endfor %}
                                 </div>
                             {% else %}
                                 <p class="text-muted small">{{ MS_TRANS.timeline_empty }}</p>
                             {% endif %}
                        </div>

                        <!-- System Interactions -->
                        <div class="col-lg-6">
                             <h5 class="fw-bold mb-3 text-secondary"><i class="bi bi-cpu me-2"></i> {{ MS_TRANS.stats_system_interactions }}</h5>
                             {% if system_interactions %}
                                 <div class="activity-timeline">
                                     {% for log in system_interactions %}
                                     <div class="timeline-item">
                                         <div class="timeline-dot" style="background-color: #fd7e14;"></div>
                                         <div class="timeline-content">
                                             <div class="timeline-time">{{ log.timestamp|date:"H:i" }}</div>
                                             <div class="timeline-title">{{ log.action }}</div>
                                             <small class="text-muted">{{ log.ip_address }}</small>
                                         </div>
                                     </div>
                                     {% endfor %}
                                 </div>
                             {% else %}
                                 <p class="text-muted small">{{ MS_TRANS.timeline_empty }}</p>
                             {% endif %}
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="row mt-4 pt-3 border-top border-light">
                        <div class="col-12 d-flex flex-wrap gap-2 justify-content-end">
                            <a class="btn btn-success action-btn rounded-pill" href="{% url 'edit_profile' %}">
                                <i class="bi bi-pencil-square h5 m-0"></i> 
                                <span>{{ MS_TRANS.btn_update_data }}</span>
                            </a>
                            
                            <button type="button" class="btn btn-danger action-btn rounded-pill" data-bs-toggle="modal" data-bs-target="#resetPasswordModal">
                                <i class="bi bi-shield-lock h5 m-0"></i>
                                <span>{{ MS_TRANS.btn_change_password }}</span>
                            </button>
                            
                            <a href="{{ APP_CONFIG.home_url }}" class="btn btn-secondary action rounded-pill">
                                <i class="bi bi-house-door h5 m-0"></i>
                                <span>{{ MS_TRANS.btn_home }}</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px; overflow: hidden;">
            <div class="modal-header bg-light border-0">
                <h5 class="modal-title fw-bold text-primary" id="resetPasswordModalLabel">
                    <i class="bi bi-key me-2"></i> {{ MS_TRANS.btn_change_password }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form method="post">
                    {% csrf_token %}
                    {{ password_form|crispy }}
                    <div class="d-grid mt-4">
                        <button type="submit" name="change_password" class="btn btn-danger action-btn rounded-pill justify-content-center">
                            {{ MS_TRANS.btn_confirm_password_change }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
